<html>
    <head>
        <title>JapHard Chat</title>

        <!--
            Copyright 2009 Aaron Barnes <aaron.barnes@hbcosmo.com>

            This program is free software: you can redistribute it and/or modify
            it under the terms of the GNU General Public License as published by
            the Free Software Foundation, either version 3 of the License, or
            (at your option) any later version.

            This program is distributed in the hope that it will be useful,
            but WITHOUT ANY WARRANTY; without even the implied warranty of
            MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
            GNU General Public License for more details.

            You should have received a copy of the GNU General Public License
            along with this program.  If not, see <http://www.gnu.org/licenses/>
        -->


        <script type="text/javascript" src="/static/libs/jquery-1.3.2.min.js"></script>

        <script type="text/javascript">

            // User hash
            var user_hash = '0';

            // Last message
            var last_message = 0;

            // Window has focus
            var has_focus = true;

            // Update has_focus when window shown/hidden
            $(window).bind("blur", function() {
                has_focus = false;
            });

            $(window).bind("focus", function() {
                has_focus = true;
                document.title = 'JapHard Chat';
            });


            // Call this function on page load
            $(function()
            {
                $(window).load(function ()
                {
                    // When set-nick-update button clicked
                    $('#set-nick-update').click(function (event)
                    {
                        // Don't post form
                        event.preventDefault();

                        // Grab new nick text box contents
                        var newnick = $('#set-nick-new').val();

                        // Reset text box
                        $('#set-nick-new').val('');

                        // Generate data
                        var data = {
                            user_hash: user_hash,
                            new_nick: newnick,
                            last_message: last_message
                        }

                        // Post message to server
                        $.get('/nick', data, chat_update, 'json');
                    });

                    // When new-message-send button clicked
                    $('#new-message-send').click(function (event)
                    {
                        // Get rid of unread title
                        document.title = 'JapHard Chat';

                        // Don't post form
                        event.preventDefault();

                        // Grab message text box contents
                        var message = $('#new-message-text').val();

                        // Reset text box
                        $('#new-message-text').val('');

                        // Generate data
                        var data = {
                            user_hash: user_hash,
                            message: message,
                            last_message: last_message
                        }

                        // Post message to server
                        $.get('/post', data, chat_update, 'json');
                    });

                    // Grab unread messages
                    poll_chat();

                    // Poll the server for updates every 3 seconds
                    var poll_interval = setInterval(poll_chat, 3000)
                });
            });

            // Poll the server for updates
            function poll_chat()
            {
                // Generate data
                var data = {
                    user_hash: user_hash,
                    last_message: last_message
                }

                // Post message to server
                $.get('/poll', data, chat_update, 'json');
            }

            // Handle reponses from server
            function chat_update(data)
            {
                // If response updates this users nick
                if (data.action == 'nick')
                {
                    user_hash = data.user_hash;
                }

                // All responses should return any new messages

                // Get last message
                last_message = data.last_message;

                // Get html
                var html = data.html;

                if (html)
                {
                    $('#chat').append(html);

                    // If window hidden, update title
                    if (has_focus == false)
                    {
                        document.title = '* JapHard Chat';
                    }
                }
            }

        </script>

        <style>

            body *
            {
                font-family: Arial, Verdana, sans-serif;
            }

            a
            {
                color: #f30;
            }

            #chat div.message
            {
                margin: 0.25em;
                border-bottom: 1px solid #aaa;
                font-size: 80%;
            }

            #chat div.server
            {
                background-color: #dedede;
            }

            #chat div.message span.author
            {
                font-weight: bold;
                padding-right: 0.5em;
            }

            #new-message
            {
                margin: 2em 0;
                border: 1px solid #ccc;
                padding: 1em;
            }

        </style>
    </head>

    <body>
        <h1>JapHard Chat</h1>

        <div id="chat">
            <div class="message server">
                <span class="message">Welcome to JapHard chat. Please update your nickname before posting a message</span>
            </div>
        </div>

        <div id="set-nick">
            <form>
                <p>
                    Nick:
                    <input type="text" id="set-nick-new" />
                </p>
                <p>
                    <input type="submit" id="set-nick-update" value="Update" />
                </p>
            </form>
        </div>

        <div id="new-message">
            <form>
                <textarea id="new-message-text"></textarea>
                <input type="submit" id="new-message-send" value="Post" />
            </form>
        </div>
    </body>
</html>
